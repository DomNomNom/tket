name: Release

on:
  release:
    types:
      - created
      - edited
  push:
    branches:
      - 'wheel/**'
      - test-apple-clang-13.1

jobs:
  build_macos_wheels:
    name: Build macos wheels
    runs-on: macos-11
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: '0'
    - run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - name: Get current time
      uses: srfrnk/current-time@v1.1.0
      id: current_time
      with:
        format: YYYYMMDDHHmmss
    - name: Cache conan data
      uses: actions/cache@v2
      with:
        path: ~/.conan
        key: ${{ runner.os }}-tket-conan-${{ steps.current_time.outputs.formattedTime }}
        restore-keys: |
          ${{ runner.os }}-tket-conan-
    - name: Set up Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: 3.7
    - name: Build tket C++
      run: |
        pip install conan
        conan profile new tket --detect --force
        conan config set general.revisions_enabled=1
        conan create --profile=tket --build=missing recipes/tket
    - name: Build wheel (3.7)
      run: .github/workflows/build_macos_wheel
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Build wheel (3.8)
      run: .github/workflows/build_macos_wheel
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Build wheel (3.9)
      run: .github/workflows/build_macos_wheel
    - uses: actions/upload-artifact@v2
      with:
        name: MacOS_wheels
        path: wheelhouse/

  build_macos_M1_wheels:
    name: Build macos (M1) wheels
    runs-on: [self-hosted, macos, M1]
    defaults:
      run:
        shell: "/usr/bin/arch -arch arm64e /bin/bash {0}"
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: '0'
    - run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - name: Build wheels
      run: |
        eval "$(pyenv init -)"
        pyenv shell tket-3.8
        conan profile new tket --detect --force
        conan config set general.revisions_enabled=1
        conan install --profile=tket boost/1.77.0@ --build=missing -o boost:without_fiber=True -o boost:without_json=True -o boost:without_nowide=True
        conan create --profile=tket recipes/tket --build=missing -o boost:without_fiber=True -o boost:without_json=True -o boost:without_nowide=True
        .github/workflows/build_macos_m1_wheel
        pyenv shell tket-3.9
        .github/workflows/build_macos_m1_wheel
    - uses: actions/upload-artifact@v2
      with:
        name: MacOS_M1_wheels
        path: wheelhouse/

  test_macos_wheels:
    name: Test macos wheels
    needs: build_macos_wheels
    runs-on: macos-11
    env:
      PYTKET_SKIP_REGISTRATION: "true"
    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9]
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Download wheels
      uses: actions/download-artifact@v2
      with:
        name: MacOS_wheels
        path: wheelhouse/
    - uses: actions/checkout@v2
      with:
        path: tket
    - name: Install wheel
      run: |
        pip install $GITHUB_WORKSPACE/wheelhouse/${{ matrix.python-version }}.*/pytket-*.whl
    - name: Run tests
      run: |
        cd tket/pytket/tests
        pip install -r requirements.txt
        pytest --ignore=simulator/ --doctest-modules

  test_macos_wheels_10_15:
    name: Test macos wheels on 10.15
    needs: build_macos_wheels
    runs-on: macos-10.15
    env:
      PYTKET_SKIP_REGISTRATION: "true"
    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9]
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Download wheels
      uses: actions/download-artifact@v2
      with:
        name: MacOS_wheels
        path: wheelhouse/
    - uses: actions/checkout@v2
      with:
        path: tket
    - name: Install wheel
      run: |
        pip install $GITHUB_WORKSPACE/wheelhouse/${{ matrix.python-version }}.*/pytket-*.whl
    - name: Run tests
      run: |
        cd tket/pytket/tests
        pip install -r requirements.txt
        pytest --ignore=simulator/ --doctest-modules

  test_macos_M1_wheels:
    name: Test macos (M1) wheels
    needs: build_macos_M1_wheels
    runs-on: [self-hosted, macos, M1]
    defaults:
      run:
        shell: "/usr/bin/arch -arch arm64e /bin/bash {0}"
    env:
      PRIVATE_PYPI_PASS: ${{ secrets.PRIVATE_PYPI_PASS }}
      PYTKET_SKIP_REGISTRATION: "true"
    strategy:
      matrix:
        python-version: [3.8, 3.9]
    steps:
    - name: Download wheels
      uses: actions/download-artifact@v2
      with:
        name: MacOS_M1_wheels
        path: wheelhouse/
    - uses: actions/checkout@v2
      with:
        path: tket
    - name: Install wheel
      run: |
        eval "$(pyenv init -)"
        pyenv shell tket-${{ matrix.python-version }}
        pip uninstall -y pytket
        pip install $GITHUB_WORKSPACE/wheelhouse/${{ matrix.python-version }}.*/pytket-*.whl
    - name: Run tests
      run: |
        eval "$(pyenv init -)"
        pyenv shell tket-${{ matrix.python-version }}
        cd pytket/tests
        pip install -r requirements.txt
        pytest --ignore=simulator/ --doctest-modules
